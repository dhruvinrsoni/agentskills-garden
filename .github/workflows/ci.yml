name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Black (format check)
        run: black --check .

      - name: Run Ruff (linter)
        run: ruff check .

      - name: Run MyPy (type check)
        run: mypy skills/ tools/ evals/ --install-types --non-interactive || true

      - name: Check Conventional Commits (PR only)
        if: github.event_name == 'pull_request'
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            test
            refactor
            perf
            chore
          requireScope: true
          scopes: |
            summarize_code
            analyze_history
            map_dependencies
            detect_smells
            clarify_requirement
            analyze_tradeoffs
            translate_stakeholder
            infra
            ci
            evals
            tools

  validate-schemas:
    name: Validate JSON Schemas
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jsonschema

      - name: Validate skill schemas
        run: |
          python -c "
          import json
          import os
          from pathlib import Path
          from jsonschema import validate, ValidationError, Draft7Validator
          
          # Load meta-schema if it exists
          meta_schema_path = Path('schemas/skill.schema.json')
          if meta_schema_path.exists():
              with open(meta_schema_path) as f:
                  meta_schema = json.load(f)
              print(f'✓ Loaded meta-schema: {meta_schema_path}')
          
          # Validate all skill schemas
          skills_dir = Path('skills')
          schema_files = list(skills_dir.rglob('schema.json'))
          
          if not schema_files:
              print('No skill schemas found yet - skipping validation')
              exit(0)
          
          for schema_file in schema_files:
              with open(schema_file) as f:
                  skill_schema = json.load(f)
              
              if meta_schema_path.exists():
                  try:
                      validate(instance=skill_schema, schema=meta_schema)
                      print(f'✓ Valid schema: {schema_file}')
                  except ValidationError as e:
                      print(f'✗ Invalid schema: {schema_file}')
                      print(f'  Error: {e.message}')
                      exit(1)
          
          print(f'\\n✓ All {len(schema_files)} schema(s) validated successfully')
          "

  test:
    name: Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest skills/ tools/ evals/ \
            --cov --cov-report=xml --cov-report=term-missing \
            -v || echo "No tests found yet - continuing"

      - name: Upload coverage to Codecov
        if: matrix.python-version == '3.11'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
          verbose: true

  build-containers:
    name: Build Skill Containers
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build base container
        run: |
          if [ -f infra/Dockerfile.base ]; then
            docker build -f infra/Dockerfile.base -t agentskills-base:test .
            echo "✓ Built base container"
          else
            echo "No base Dockerfile found yet - skipping"
          fi

      - name: Build skill containers
        run: |
          skill_count=0
          for skill_dockerfile in $(find skills -name Dockerfile); do
            skill_dir=$(dirname "$skill_dockerfile")
            skill_name=$(basename "$skill_dir")
            echo "Building $skill_name..."
            docker build -f "$skill_dockerfile" -t "agentskills-$skill_name:test" "$skill_dir" || true
            skill_count=$((skill_count + 1))
          done
          
          if [ $skill_count -eq 0 ]; then
            echo "No skill containers found yet - skipping"
          else
            echo "✓ Built $skill_count skill container(s)"
          fi

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, validate-schemas, test, build-containers]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "❌ Lint failed"
            exit 1
          fi
          if [ "${{ needs.validate-schemas.result }}" != "success" ]; then
            echo "❌ Schema validation failed"
            exit 1
          fi
          if [ "${{ needs.test.result }}" != "success" ]; then
            echo "❌ Tests failed"
            exit 1
          fi
          if [ "${{ needs.build-containers.result }}" != "success" ]; then
            echo "❌ Container builds failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"
